# This workflow will build a Java project with Maven
# For more information see: https://help.github.com/actions/language-and-framework-guides/building-and-testing-java-with-maven

name: Maven Test Build

on:
  push:
  workflow_dispatch:

jobs:
  maven_build:
    name: Maven-Build (Linux)
    runs-on: ubuntu-latest

    steps:
      - name: Start Redpanda
        run: |
          docker run -d --name=redpanda \
            -p 9092:9092 \
            docker.redpanda.com/redpandadata/redpanda:latest \
            redpanda start \
              --overprovisioned \
              --smp 1 \
              --memory 1G \
              --reserve-memory 0M \
              --node-id 0 \
              --check=false \
              --kafka-addr INSIDE://0.0.0.0:29092,OUTSIDE://0.0.0.0:9092 \
              --advertise-kafka-addr INSIDE://redpanda:29092,OUTSIDE://localhost:9092 \
              --advertise-kafka-addr PLAINTEXT://localhost:9092 \
              --pandaproxy-addr 0.0.0.0:8082 \
              --schema-registry-addr 0.0.0.0:8081
      - name: Wait for Redpanda to be healthy
        run: |
          echo "Waiting for Redpanda to be healthy..."
          for i in {1..30}; do  # ~30 × 2s = 60 Sekunden Timeout
            if [ "$(docker inspect -f '{{.State.Health.Status}}' redpanda 2>/dev/null)" = "healthy" ]; then
              echo "✅ Redpanda is healthy!"
              exit 0
            fi
            echo "⏳ Still waiting..."
            sleep 2
          done
          echo "❌ Timeout: Redpanda did not become healthy in time"
          exit 1

      - uses: actions/checkout@v5
      - name: Set up JDK 25
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: 25
      - name: Build with Maven
        run: mvn -B install --file pom.xml
